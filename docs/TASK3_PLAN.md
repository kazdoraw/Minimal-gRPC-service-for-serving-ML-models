# Задание 3: Настройка стратегий развертывания модели

## Цель задания
Реализовать Blue-Green deployment стратегию для ML-сервиса с автоматизацией через CI/CD (GitHub Actions).

## Контекст
- **Базовый проект:** gRPC ML Service (Задание 2)
- **Стратегия:** Blue-Green Deployment (Вариант A)
- **Технологии:** Docker, Docker Compose, Nginx, GitHub Actions
- **Максимальный балл:** 10

## Структура задания

### Этап 0: Подготовка и планирование
- Анализ текущего состояния проекта
- Определение изменений для поддержки Blue-Green
- Создание плана выполнения

### Этап 1: Подготовка ML-сервиса
**Цель:** Адаптировать существующий gRPC сервис для поддержки версионирования

**Задачи:**
1. Проверить текущую реализацию /health эндпоинта
2. Убедиться, что MODEL_VERSION передается через переменные окружения
3. Проверить работоспособность существующей модели
4. Создать вторую версию модели (v1.1.0) для тестирования Blue-Green

**Критерий завершения:**
- ✅ Health эндпоинт возвращает версию модели
- ✅ Версия конфигурируется через ENV
- ✅ Есть две версии модели: v1.0.0 и v1.1.0

### Этап 2: Создание Docker Compose конфигураций
**Цель:** Подготовить инфраструктуру для Blue-Green deployment

**Задачи:**
1. Создать `docker-compose.blue.yml` (версия v1.0.0)
2. Создать `docker-compose.green.yml` (версия v1.1.0)
3. Настроить порты и сети для изоляции версий
4. Проверить локальный запуск обеих версий

**Критерий завершения:**
- ✅ Blue версия запускается на порту 50051
- ✅ Green версия запускается на порту 50052
- ✅ Обе версии работают параллельно
- ✅ Health проверка доступна для обеих

### Этап 3: Настройка балансировщика (Nginx)
**Цель:** Реализовать переключение трафика между версиями

**Задачи:**
1. Создать конфигурацию Nginx для gRPC
2. Настроить upstream для Blue и Green
3. Реализовать переключение через изменение конфигурации
4. Добавить health checks в Nginx
5. Протестировать переключение трафика

**Критерий завершения:**
- ✅ Nginx маршрутизирует на активную версию
- ✅ Переключение происходит без downtime
- ✅ Health checks работают корректно

### Этап 4: Реализация механизма переключения и отката
**Цель:** Автоматизировать управление версиями

**Задачи:**
1. Создать скрипт `switch.sh` для переключения Blue↔Green
2. Создать скрипт `rollback.sh` для отката
3. Реализовать проверку здоровья перед переключением
4. Добавить логирование операций
5. Протестировать все сценарии

**Критерий завершения:**
- ✅ Переключение выполняется одной командой
- ✅ Откат работает корректно
- ✅ Проверка здоровья предотвращает некорректное переключение

### Этап 5: Настройка CI/CD (GitHub Actions)
**Цель:** Автоматизировать деплой через GitHub Actions

**Задачи:**
1. Создать `.github/workflows/deploy.yml`
2. Настроить сборку Docker образов
3. Настроить push в GitHub Container Registry
4. Реализовать автоматический деплой
5. Добавить проверку health после деплоя
6. Настроить GitHub Secrets

**Критерий завершения:**
- ✅ Workflow запускается на push в main
- ✅ Образ собирается и публикуется
- ✅ Health check выполняется после деплоя
- ✅ Секреты используются корректно

### Этап 6: Тестирование и документация
**Цель:** Проверить работоспособность и задокументировать

**Задачи:**
1. Провести полное тестирование Blue-Green
2. Сделать скриншоты /health и /predict
3. Обновить README.md с инструкциями
4. Создать документацию по деплою
5. Проверить все критерии оценивания

**Критерий завершения:**
- ✅ Все сценарии протестированы
- ✅ Скриншоты готовы
- ✅ README.md обновлен
- ✅ Документация полная

### Этап 7: Финализация и сдача
**Цель:** Подготовить проект к сдаче

**Задачи:**
1. Проверить структуру репозитория
2. Убедиться в наличии всех обязательных файлов
3. Закоммитить и запушить в GitHub
4. Проверить работу CI/CD в GitHub
5. Подготовить ссылку на репозиторий

**Критерий завершения:**
- ✅ Все файлы в репозитории
- ✅ CI/CD работает
- ✅ README корректен
- ✅ Проект готов к сдаче

## Обязательные файлы для сдачи

```
/Users/Shared/ml/DEPLOY/HW2/
├── Dockerfile                          # Существует
├── docker-compose.blue.yml             # Создать
├── docker-compose.green.yml            # Создать
├── nginx/
│   └── nginx.conf                      # Создать
├── scripts/
│   ├── switch.sh                       # Создать
│   └── rollback.sh                     # Создать
├── .github/
│   └── workflows/
│       └── deploy.yml                  # Создать
├── models/
│   ├── v1.0.0/
│   │   └── model.pkl                   # Существует
│   └── v1.1.0/
│       └── model.pkl                   # Создать
├── docs/
│   ├── DEPLOYMENT.md                   # Создать
│   └── screenshots/                    # Создать
└── README.md                           # Обновить
```

## Критерии оценивания (10 баллов)

| Критерий | Баллы | Статус |
|----------|-------|--------|
| 1. Структура репозитория и документация | 2 | ⏳ |
| 2. Контейнеризация и локальный запуск | 2 | ⏳ |
| 3. Реализация Blue-Green стратегии | 2 | ⏳ |
| 4. CI/CD и деплой через GitHub Actions | 2 | ⏳ |
| 5. Мониторинг и документация | 2 | ⏳ |

## Технические детали

### Версии моделей
- **v1.0.0:** Текущая модель (LogisticRegression, accuracy 100%)
- **v1.1.0:** Новая версия (будем использовать ту же модель с другими параметрами)

### Порты
- **Blue (v1.0.0):** 50051
- **Green (v1.1.0):** 50052
- **Nginx:** 50050 (фронтенд)

### Переменные окружения
```bash
MODEL_VERSION=v1.0.0
MODEL_PATH=/app/models/v1.0.0/model.pkl
PORT=50051
```

## Риски и ограничения

### Риски:
1. gRPC через Nginx требует особой конфигурации (HTTP/2)
2. Health checks для gRPC отличаются от HTTP
3. GitHub Actions требует правильной настройки секретов
4. Локальное тестирование ограничено (нет реального облака)

### Решения:
1. Использовать Nginx с grpc_pass
2. Реализовать HTTP health endpoint дополнительно
3. Использовать GitHub Container Registry (GHCR)
4. Эмулировать деплой через docker-compose

## Следующий шаг
Начинаем с Этапа 1: Подготовка ML-сервиса
